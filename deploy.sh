#!/bin/bash

# xCloud Storage Deployment Script for Ubuntu
# ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ñ€Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸Ñ

set -e

echo "ðŸš€ ÐÐ°Ñ‡Ð¸Ð½Ð°ÐµÐ¼ Ñ€Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸Ðµ xCloud Storage..."

# ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹
echo "ðŸ“¦ ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹..."
sudo apt update && sudo apt upgrade -y

# Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Node.js (LTS Ð²ÐµÑ€ÑÐ¸Ñ)
echo "ðŸ“¦ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Node.js..."
curl -fsSL https://deb.nodesource.com/setup_lts.x | sudo -E bash -
sudo apt-get install -y nodejs

# Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° PM2 Ð´Ð»Ñ ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐ°Ð¼Ð¸
echo "ðŸ“¦ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° PM2..."
sudo npm install -g pm2

# Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° nginx
echo "ðŸ“¦ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Nginx..."
sudo apt install -y nginx

# Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð´Ð»Ñ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ
echo "ðŸ‘¤ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ..."
sudo useradd -m -s /bin/bash xcloud || echo "ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ xcloud ÑƒÐ¶Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚"

# Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¹
echo "ðŸ“ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¹..."
sudo mkdir -p /opt/xcloud
sudo mkdir -p /opt/xcloud/logs
sudo mkdir -p /opt/xcloud/storage
sudo mkdir -p /var/log/xcloud

# ÐšÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ñ„Ð°Ð¹Ð»Ð¾Ð²
echo "ðŸ“‹ ÐšÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ñ„Ð°Ð¹Ð»Ð¾Ð²..."
sudo cp -r . /opt/xcloud/
sudo chown -R xcloud:xcloud /opt/xcloud
sudo chown -R xcloud:xcloud /var/log/xcloud

# Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹
echo "ðŸ“¦ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹..."
cd /opt/xcloud
sudo -u xcloud npm install --production

# ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° PM2
echo "âš™ï¸ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° PM2..."
sudo -u xcloud pm2 start ecosystem.config.js
sudo -u xcloud pm2 save
sudo -u xcloud pm2 startup

# Ð–Ð´ÐµÐ¼ Ð·Ð°Ð¿ÑƒÑÐºÐ° PM2
echo "â³ ÐžÐ¶Ð¸Ð´Ð°Ð½Ð¸Ðµ Ð·Ð°Ð¿ÑƒÑÐºÐ° PM2..."
sleep 5

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑ‚Ð°Ñ‚ÑƒÑ PM2
echo "ðŸ“Š Ð¡Ñ‚Ð°Ñ‚ÑƒÑ PM2:"
sudo -u xcloud pm2 list

echo ""
echo "âœ… ÐŸÐµÑ€Ð²Ð°Ñ Ñ‡Ð°ÑÑ‚ÑŒ Ñ€Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸Ñ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°!"
echo "ðŸ“‹ PM2 Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ð¸ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚"
echo ""
echo "ðŸš€ Ð”Ð»Ñ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ñ Ñ€Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸Ñ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ:"
echo "   sudo bash deploy-part2.sh"
echo ""
echo "â³ Ð˜Ð»Ð¸ Ð¿Ð¾Ð´Ð¾Ð¶Ð´Ð¸Ñ‚Ðµ 10 ÑÐµÐºÑƒÐ½Ð´ Ð´Ð»Ñ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ð³Ð¾ Ð¿Ñ€Ð¾Ð´Ð¾Ð»Ð¶ÐµÐ½Ð¸Ñ..."
sleep 10

# Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Certbot Ð´Ð»Ñ SSL
echo "ðŸ“¦ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Certbot..."
sudo apt install -y certbot python3-certbot-nginx

# ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Nginx Ñ HTTPS
echo "âš™ï¸ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Nginx Ñ HTTPS..."
sudo tee /etc/nginx/sites-available/xcloud > /dev/null <<EOF
# HTTP to HTTPS redirect
server {
    listen 80;
    server_name cloud.l0.mom _;
    return 301 https://cloud.l0.mom\$request_uri;
}

# HTTPS configuration
server {
    listen 443 ssl http2;
    server_name cloud.l0.mom _;
    
    # SSL configuration (will be updated by certbot)
    ssl_certificate /etc/ssl/certs/ssl-cert-snakeoil.pem;
    ssl_certificate_key /etc/ssl/private/ssl-cert-snakeoil.key;
    
    # Security headers
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Frame-Options DENY;
    add_header X-Content-Type-Options nosniff;
    add_header Referrer-Policy "strict-origin-when-cross-origin";
    
    # ÐœÐ°ÐºÑÐ¸Ð¼Ð°Ð»ÑŒÐ½Ñ‹Ð¹ Ñ€Ð°Ð·Ð¼ÐµÑ€ Ð·Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼Ð¾Ð³Ð¾ Ñ„Ð°Ð¹Ð»Ð°
    client_max_body_size 100M;
    
    # Static files caching
    location ~* \.(css|js|png|jpg|jpeg|gif|ico|svg)$ {
        proxy_pass http://localhost:3000;
        proxy_cache_valid 200 1d;
        expires 1d;
        add_header Cache-Control "public, immutable";
    }
    
    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade \$http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto https;
        proxy_cache_bypass \$http_upgrade;
        
        # Ð¢Ð°Ð¹Ð¼Ð°ÑƒÑ‚Ñ‹ Ð´Ð»Ñ Ð±Ð¾Ð»ÑŒÑˆÐ¸Ñ… Ñ„Ð°Ð¹Ð»Ð¾Ð²
        proxy_connect_timeout 300s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
    }
}
EOF

# ÐÐºÑ‚Ð¸Ð²Ð°Ñ†Ð¸Ñ ÑÐ°Ð¹Ñ‚Ð°
sudo ln -sf /etc/nginx/sites-available/xcloud /etc/nginx/sites-enabled/
sudo rm -f /etc/nginx/sites-enabled/default

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸ Nginx
sudo nginx -t

# ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐº ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð²
echo "ðŸ”„ ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐº ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð²..."
sudo systemctl restart nginx
sudo systemctl enable nginx

# ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ñ„Ð°Ð¹Ñ€Ð²Ð¾Ð»Ð°
echo "ðŸ”¥ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ñ„Ð°Ð¹Ñ€Ð²Ð¾Ð»Ð°..."
sudo ufw allow 22/tcp
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw --force enable

# Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ systemd ÑÐµÑ€Ð²Ð¸ÑÐ° Ð´Ð»Ñ PM2
echo "âš™ï¸ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ systemd ÑÐµÑ€Ð²Ð¸ÑÐ°..."
sudo tee /etc/systemd/system/xcloud.service > /dev/null <<EOF
[Unit]
Description=xCloud Storage Service
After=network.target

[Service]
Type=forking
User=xcloud
Group=xcloud
WorkingDirectory=/opt/xcloud
ExecStart=/usr/bin/pm2 start ecosystem.config.js --no-daemon
ExecReload=/usr/bin/pm2 reload ecosystem.config.js
ExecStop=/usr/bin/pm2 stop ecosystem.config.js
Restart=always
RestartSec=10
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
EOF

# ÐÐºÑ‚Ð¸Ð²Ð°Ñ†Ð¸Ñ ÑÐµÑ€Ð²Ð¸ÑÐ°
sudo systemctl daemon-reload
sudo systemctl enable xcloud
sudo systemctl start xcloud

# Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ ÑÐºÑ€Ð¸Ð¿Ñ‚Ð° Ð´Ð»Ñ ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ
echo "ðŸ“ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ ÑÐºÑ€Ð¸Ð¿Ñ‚Ð° ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ..."
sudo tee /usr/local/bin/xcloud > /dev/null <<EOF
#!/bin/bash
case "\$1" in
    start)
        sudo systemctl start xcloud
        ;;
    stop)
        sudo systemctl stop xcloud
        ;;
    restart)
        sudo systemctl restart xcloud
        ;;
    status)
        sudo systemctl status xcloud
        ;;
    logs)
        sudo journalctl -u xcloud -f
        ;;
    *)
        echo "Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ: xcloud {start|stop|restart|status|logs}"
        exit 1
        ;;
esac
EOF

sudo chmod +x /usr/local/bin/xcloud

# Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ ÑÐºÑ€Ð¸Ð¿Ñ‚Ð° Ð´Ð»Ñ SSL (Let's Encrypt)
echo "ðŸ“ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ ÑÐºÑ€Ð¸Ð¿Ñ‚Ð° SSL..."
sudo tee /usr/local/bin/xcloud-ssl > /dev/null <<EOF
#!/bin/bash
echo "ðŸ”’ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° SSL ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð° Ð´Ð»Ñ Ð´Ð¾Ð¼ÐµÐ½Ð°: cloud.l0.mom"

# ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° SSL Ð´Ð»Ñ Ð´Ð¾Ð¼ÐµÐ½Ð°
echo "ðŸ”§ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° SSL Ð´Ð»Ñ Ð´Ð¾Ð¼ÐµÐ½Ð°: cloud.l0.mom"
sudo certbot --nginx -d cloud.l0.mom --non-interactive --agree-tos --email admin@cloud.l0.mom

echo "âœ… SSL ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐ½!"
echo "ðŸŒ ÐŸÑ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ Ð¿Ð¾ Ð°Ð´Ñ€ÐµÑÑƒ: https://cloud.l0.mom"
EOF

sudo chmod +x /usr/local/bin/xcloud-ssl

# ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ°Ñ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° SSL ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð°
echo "ðŸ”’ ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° SSL ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð° Ð´Ð»Ñ cloud.l0.mom..."
sudo certbot --nginx -d cloud.l0.mom --non-interactive --agree-tos --email admin@cloud.l0.mom || echo "âš ï¸  Certbot Ð½Ðµ ÑÐ¼Ð¾Ð³ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¸Ñ‚ÑŒ SSL"

echo ""
echo "âœ… Ð Ð°Ð·Ð²ÐµÑ€Ñ‚Ñ‹Ð²Ð°Ð½Ð¸Ðµ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¾!"
echo ""
echo "ðŸ”‘ API ÐšÐ»ÑŽÑ‡Ð¸:"
echo "   Main Key: main_key_2024_secure_12345"
echo "   Upload Key: upload_key_2024_secure_67890"
echo ""
echo "ðŸŒ Ð”Ð¾ÑÑ‚ÑƒÐ¿ Ðº Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸ÑŽ:"
echo "   https://cloud.l0.mom (Ñ SSL ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð¾Ð¼)"
echo "   http://cloud.l0.mom (Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð¿ÐµÑ€ÐµÐ½Ð°Ð¿Ñ€Ð°Ð²Ð»ÑÐµÑ‚ÑÑ Ð½Ð° HTTPS)"
echo ""
echo "ðŸ“‹ Ð£Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ ÑÐµÑ€Ð²Ð¸ÑÐ¾Ð¼:"
echo "   xcloud start    - Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ"
echo "   xcloud stop     - Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ"
echo "   xcloud restart  - Ð¿ÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ"
echo "   xcloud status   - ÑÑ‚Ð°Ñ‚ÑƒÑ"
echo "   xcloud logs     - Ð»Ð¾Ð³Ð¸"
echo ""
echo "ðŸ”’ Ð”Ð»Ñ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ SSL ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð° (Let's Encrypt):"
echo "   xcloud-ssl"
echo ""
echo "ðŸ“ Ð¤Ð°Ð¹Ð»Ñ‹ Ñ…Ñ€Ð°Ð½ÑÑ‚ÑÑ Ð²: /opt/xcloud/storage"
echo "ðŸ“‹ Ð›Ð¾Ð³Ð¸ Ð²: /var/log/xcloud/"
echo ""
