#!/bin/bash

# xCloud Storage - Universal Update Script
# –†–∞–±–æ—Ç–∞–µ—Ç –∏–∑ –ª—é–±–æ–π –ø–∞–ø–∫–∏, –æ–±–Ω–æ–≤–ª—è–µ—Ç /opt/xcloud

set -e

echo "üîÑ xCloud Storage - Universal Update"
echo "===================================="

# Colors for output
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

print_status() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

print_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

print_step() {
    echo -e "${BLUE}[STEP]${NC} $1"
}

# –ü—Ä–æ–≤–µ—Ä–∫–∞ root –ø—Ä–∞–≤
if [ "$EUID" -ne 0 ]; then
    print_error "–ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å sudo: sudo bash update.sh"
    exit 1
fi

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∏—Å—Ö–æ–¥–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é (–≥–¥–µ –∑–∞–ø—É—â–µ–Ω —Å–∫—Ä–∏–ø—Ç)
SOURCE_DIR="$(pwd)"
print_status "–ò—Å—Ö–æ–¥–Ω–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $SOURCE_DIR"

# –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ –≤ –∏—Å—Ö–æ–¥–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –µ—Å—Ç—å —Ñ–∞–π–ª—ã –ø—Ä–æ–µ–∫—Ç–∞
if [ ! -f "$SOURCE_DIR/package.json" ] || [ ! -f "$SOURCE_DIR/server.js" ]; then
    print_error "–§–∞–π–ª—ã –ø—Ä–æ–µ–∫—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ $SOURCE_DIR"
    print_error "–ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç –∏–∑ –ø–∞–ø–∫–∏ —Å –ø—Ä–æ–µ–∫—Ç–æ–º xCloud"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ git –≤ –∏—Å—Ö–æ–¥–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
if [ ! -d "$SOURCE_DIR/.git" ]; then
    print_error "Git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ $SOURCE_DIR"
    exit 1
fi

print_step "1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ —Å—Ç–∞—Ç—É—Å–∞..."

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ —Å—Ç–∞—Ç—É—Å–∞ —Å–µ—Ä–≤–∏—Å–∞
if systemctl is-active --quiet xcloud; then
    print_status "–°–µ—Ä–≤–∏—Å xcloud –∑–∞–ø—É—â–µ–Ω"
else
    print_warning "–°–µ—Ä–≤–∏—Å xcloud –Ω–µ –∑–∞–ø—É—â–µ–Ω"
fi

# –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –∏—Å—Ö–æ–¥–Ω—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å git
cd "$SOURCE_DIR"

# –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–µ–∫—É—â–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π
print_step "2. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–µ–∫—É—â–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π..."
git stash push -m "Auto-save before update $(date)" || print_warning "–ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è"

# –ü–æ–ª—É—á–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π —Å GitHub
print_step "3. –ü–æ–ª—É—á–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π —Å GitHub..."
git fetch origin

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
LOCAL=$(git rev-parse HEAD)
REMOTE=$(git rev-parse origin/main)

if [ "$LOCAL" = "$REMOTE" ]; then
    print_status "Git —É–∂–µ –ø–æ—Å–ª–µ–¥–Ω—è—è –≤–µ—Ä—Å–∏—è, –Ω–æ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º —Ñ–∞–π–ª—ã..."
else
    print_status "–ù–∞–π–¥–µ–Ω—ã –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è. –ù–∞—á–∏–Ω–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ..."
fi

# –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤
print_step "4. –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤..."
systemctl stop xcloud 2>/dev/null || print_warning "–°–µ—Ä–≤–∏—Å xcloud —É–∂–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"

# –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞ (–ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –ª–æ–∫–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è)
print_step "5. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞ —Å GitHub..."
git reset --hard origin/main

# –û—á–∏—Å—Ç–∫–∞ –∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –≤ –ø—Ä–æ–¥–∞–∫—à–Ω –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
print_step "6. –û—á–∏—Å—Ç–∫–∞ –∏ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –≤ /opt/xcloud..."

# –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤–∞–∂–Ω—ã–µ —Ñ–∞–π–ª—ã –∏–∑ Important_files
if [ -f "/opt/xcloud/Important_files/prod.env" ]; then
    cp /opt/xcloud/Important_files/prod.env /tmp/prod.env.backup
    print_status "–°–æ—Ö—Ä–∞–Ω–µ–Ω prod.env –∏–∑ Important_files"
fi

if [ -f "/opt/xcloud/Important_files/.public_links.json" ]; then
    cp /opt/xcloud/Important_files/.public_links.json /tmp/public_links.json.backup
    print_status "–°–æ—Ö—Ä–∞–Ω–µ–Ω .public_links.json"
fi

# –í–ê–ñ–ù–û: –ü–∞–ø–∫–∞ /opt/xcloud/storage —Å–æ–¥–µ—Ä–∂–∏—Ç —Ñ–∞–π–ª—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π - –ù–ï –£–î–ê–õ–Ø–ï–ú!
print_status "–ó–∞—â–∏—â–∞–µ–º –ø–∞–ø–∫—É storage —Å —Ñ–∞–π–ª–∞–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"

# –í–ê–ñ–ù–û: –ü–∞–ø–∫–∞ /opt/xcloud/Important_files —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ - –ù–ï –£–î–ê–õ–Ø–ï–ú!
print_status "–ó–∞—â–∏—â–∞–µ–º –ø–∞–ø–∫—É Important_files —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏"

# –û—á–∏—â–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é (–∫—Ä–æ–º–µ node_modules, storage, Important_files –∏ prod.env)
print_status "–û—á–∏—Å—Ç–∫–∞ /opt/xcloud..."
find /opt/xcloud -maxdepth 1 -type f -name "*.js" -delete
find /opt/xcloud -maxdepth 1 -type f -name "*.json" -delete
find /opt/xcloud -maxdepth 1 -type f -name "*.md" -delete
find /opt/xcloud -maxdepth 1 -type f -name "*.sh" -delete
find /opt/xcloud -maxdepth 1 -type f -name "example.env" -delete
rm -rf /opt/xcloud/public
# –ù–ï —É–¥–∞–ª—è–µ–º storage - —Ç–∞–º —Ñ–∞–π–ª—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π!
# –ù–ï —É–¥–∞–ª—è–µ–º Important_files - —Ç–∞–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏!

# –ö–æ–ø–∏—Ä—É–µ–º –Ω–æ–≤—ã–µ —Ñ–∞–π–ª—ã, –∏—Å–∫–ª—é—á–∞—è storage –∏ Important_files
print_status "–ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ (–∏—Å–∫–ª—é—á–∞—è storage –∏ Important_files)..."
rsync -av --exclude='storage' --exclude='Important_files' --exclude='node_modules' "$SOURCE_DIR"/ /opt/xcloud/

# –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–∞–∂–Ω—ã–µ —Ñ–∞–π–ª—ã –≤ Important_files
if [ -f "/tmp/prod.env.backup" ]; then
    cp /tmp/prod.env.backup /opt/xcloud/Important_files/prod.env
    rm /tmp/prod.env.backup
    print_status "–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω prod.env –≤ Important_files"
fi

if [ -f "/tmp/public_links.json.backup" ]; then
    cp /tmp/public_links.json.backup /opt/xcloud/Important_files/.public_links.json
    rm /tmp/public_links.json.backup
    print_status "–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω .public_links.json"
fi

# –°–æ–∑–¥–∞–µ–º —Å–∏–º–ª–∏–Ω–∫ –Ω–∞ prod.env –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
if [ ! -f "/opt/xcloud/prod.env" ] && [ -f "/opt/xcloud/Important_files/prod.env" ]; then
    ln -s /opt/xcloud/Important_files/prod.env /opt/xcloud/prod.env
    print_status "–°–æ–∑–¥–∞–Ω —Å–∏–º–ª–∏–Ω–∫ –Ω–∞ prod.env"
fi

# –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É storage –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
if [ ! -d "/opt/xcloud/storage" ]; then
    mkdir -p /opt/xcloud/storage
    print_status "–°–æ–∑–¥–∞–Ω–∞ –ø–∞–ø–∫–∞ storage"
else
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Ñ–∞–π–ª—ã –≤ storage
    file_count=$(find /opt/xcloud/storage -type f | wc -l)
    if [ "$file_count" -gt 0 ]; then
        print_status "–ù–∞–π–¥–µ–Ω–æ $file_count —Ñ–∞–π–ª–æ–≤ –≤ storage - –∑–∞—â–∏—â–µ–Ω—ã –æ—Ç —É–¥–∞–ª–µ–Ω–∏—è"
    else
        print_status "–ü–∞–ø–∫–∞ storage –ø—É—Å—Ç–∞"
    fi
fi

# –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É Important_files –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
if [ ! -d "/opt/xcloud/Important_files" ]; then
    mkdir -p /opt/xcloud/Important_files
    print_status "–°–æ–∑–¥–∞–Ω–∞ –ø–∞–ø–∫–∞ Important_files"
else
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Ñ–∞–π–ª—ã –≤ Important_files
    file_count=$(find /opt/xcloud/Important_files -type f | wc -l)
    if [ "$file_count" -gt 0 ]; then
        print_status "–ù–∞–π–¥–µ–Ω–æ $file_count —Ñ–∞–π–ª–æ–≤ –≤ Important_files - –∑–∞—â–∏—â–µ–Ω—ã –æ—Ç —É–¥–∞–ª–µ–Ω–∏—è"
    else
        print_status "–ü–∞–ø–∫–∞ Important_files –ø—É—Å—Ç–∞"
    fi
fi

# –°—Ä–∞–∑—É –∏—Å–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
chown -R xcloud:xcloud /opt/xcloud
chmod -R 755 /opt/xcloud

print_status "–§–∞–π–ª—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã –≤ /opt/xcloud"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
print_step "7. –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏..."
cd /opt/xcloud
if [ ! -f "prod.env" ]; then
    print_error "prod.env –Ω–µ –Ω–∞–π–¥–µ–Ω! –°–æ–∑–¥–∞–π—Ç–µ –µ–≥–æ –≤—Ä—É—á–Ω—É—é –∏–∑ example.env"
    print_status "cp example.env prod.env"
    print_status "nano prod.env"
    exit 1
else
    print_status "prod.env –Ω–∞–π–¥–µ–Ω, —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏"
fi

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
print_step "8. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
# –°–Ω–∞—á–∞–ª–∞ –∏—Å–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–∞–≤–∞ –Ω–∞ –≤—Å–µ —Ñ–∞–π–ª—ã
chown -R xcloud:xcloud /opt/xcloud
chmod -R 755 /opt/xcloud
# –ó–∞—Ç–µ–º —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è xcloud
sudo -u xcloud npm install --production

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
if [ ! -f "config.js" ]; then
    print_error "–§–∞–π–ª config.js –Ω–µ –Ω–∞–π–¥–µ–Ω!"
    exit 1
fi

# –ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ —É–∂–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–∞ —à–∞–≥–µ 6
print_step "9. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞..."
print_status "–ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ —É–∂–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã"

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤
print_step "10. –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤..."
systemctl start xcloud

# –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞
print_step "11. –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–∞..."
sleep 5

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
print_step "12. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Å–µ—Ä–≤–∏—Å–æ–≤..."

if systemctl is-active --quiet xcloud; then
    print_status "‚úÖ –°–µ—Ä–≤–∏—Å xcloud –∑–∞–ø—É—â–µ–Ω —É—Å–ø–µ—à–Ω–æ"
else
    print_error "‚ùå –°–µ—Ä–≤–∏—Å xcloud –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è"
    print_status "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: journalctl -u xcloud -f"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ nginx
print_step "13. –ü—Ä–æ–≤–µ—Ä–∫–∞ Nginx..."
if nginx -t > /dev/null 2>&1; then
    print_status "‚úÖ Nginx –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞"
    systemctl reload nginx
else
    print_warning "‚ö†Ô∏è  –ü—Ä–æ–±–ª–µ–º—ã —Å nginx –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π"
    print_status "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ: nginx -t"
fi

# –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
print_step "14. –§–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞..."
sleep 3

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
if curl -s http://localhost:3000/api/health > /dev/null; then
    print_status "‚úÖ –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –∑–∞–ø—Ä–æ—Å—ã"
else
    print_warning "‚ö†Ô∏è  –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ localhost:3000"
    print_status "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: journalctl -u xcloud -f"
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–Ω–µ—à–Ω–µ–≥–æ –¥–æ—Å—Ç—É–ø–∞
if curl -s https://cloud.l0.mom/api/health > /dev/null; then
    print_status "‚úÖ –í–Ω–µ—à–Ω–∏–π –¥–æ—Å—Ç—É–ø —Ä–∞–±–æ—Ç–∞–µ—Ç"
else
    print_warning "‚ö†Ô∏è  –í–Ω–µ—à–Ω–∏–π –¥–æ—Å—Ç—É–ø –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç"
fi

echo ""
echo "üéâ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
echo "========================="
echo ""
echo "üìä –°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–æ–≤:"
echo "   systemctl status xcloud"
echo ""
echo "üåê –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ –ø–æ –∞–¥—Ä–µ—Å—É:"
echo "   https://cloud.l0.mom"
echo ""
echo "üìã –õ–æ–≥–∏:"
echo "   journalctl -u xcloud -f"
echo ""
echo "üîÑ –î–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Å—Ç–æ –∑–∞–ø—É—Å—Ç–∏—Ç–µ:"
echo "   sudo bash update.sh"
